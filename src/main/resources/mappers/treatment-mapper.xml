<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="treatmentMapper">
	<!-- 캘린더 조회용 result
	<resultMap id="calendarResult" type="Calendar">
		<result column="calendar_no" property="calendarNo" />
		<result column="calendar_title" property="calendarTitle" />
		<result column="calendar_start" property="calendarStart" />
		<result column="calendar_end" property="calendarEnd" />
		<result column="textcolor" property="textColor" />
		<result column="backgroundcolor" property="backgroundColor" />
	</resultMap>
	-->
	
	<!-- 수술실 result -->
	<resultMap id="OPResult" type="RevOProom">
		<result column="booking_no" property="bookingNo" />
		<result column="clinic_no" property="clinicNo" />
		<result column="surgery_no" property="surgeryNo" />
		<result column="room_name" property="roomName" />
		<result column="surgery_date" property="surDate" />
		<result column="sur_starttime" property="surStartTime" />
		<result column="memo" property="memo" />
		<result column="surgery_status" property="surStatus" />
		<result column="doctor_name" property="doctorName" />
		<result column="sur_endtime" property="surEndTime" />
		<result column="calendar_no" property="calendarNo" />
		<result column="textcolor" property="textColor" />
		<result column="backgroundcolor" property="backgroundColor" />
	</resultMap>
	
	<!-- clinic result -->
	<resultMap id="ClinicResult" type="Clinic">
		<result column="clinic_no" property="clinicNo" />
		<result column="chart_no" property="chartNo" />
		<result column="dept_no" property="deptNo" />
		<result column="enroll_time" property="enrollTime" />
		<result column="enroll_date" property="enrollDate" />
		<result column="diagnosis_content" property="diagnosisContent" />
		<result column="surgery" property="surgery" />
		<result column="enter" property="enter" />
		<result column="status" property="status" />
		<result column="surgery_no2" property="surgeryNo2" />
		<result column="diseases_code" property="diseaseCode" />
		<result column="emp_no" property="empNo" />
		<result column="fee" property="fee" />
	</resultMap>



	<!-- patient result -->
	<resultMap id="PatientResult" type="Patient">
		<result column="chart_no" property="chartNo" />
		<result column="last_dep" property="lastDep" />
		<result column="patient_name" property="patientName" />
		<result column="id_no" property="idNo" />
		<result column="address" property="address" />
		<result column="memo" property="memo" />
		<result column="first_visit" property="firstVisit" />
		<result column="last_visit" property="lastVisit" />
		<result column="phone" property="phone" />
		<result column="protector" property="protector" />
		<result column="new" property="newOne" />
	</resultMap>
	
	<!-- surgery result -->
	<resultMap id="SurgeryResult" type="Surgery">
		<result column="surgery_no" property="surgeryNo" />
		<result column="surgery_name" property="surgeryName" />
		<result column="period" property="period" />
		<result column="s_payment" property="sPayment" />
		<result column="lead_time" property="leadTime" />
	</resultMap>
	
	<!-- listSurgeryBook result -->
	<resultMap id="SurBookResult" type="ListSurgeryBooking">
		<collection resultMap="SurgeryResult" property="Surgery"/>
		<collection resultMap="PatientResult" property="Patient"/>
		<collection resultMap="ClinicResult" property="Clinic"/>
		<collection resultMap="OPResult" property="RevOProom"/>
	</resultMap>
	

	

	
	<!-- 캘린더 조회 mapper 예시
	<select id="calendarList" resultMap="calendarResult">
		select
			   calendar_no
			 , calendar_title
			 , calendar_start
			 , calendar_end
			 , textcolor
			 , backgroundcolor
		  from sur_calendar

	</select>
	-->
	
	<!-- 수술실 캘린더 조회 select -->
	<select id="calendarList" resultMap="OPResult">
		select
			   calendar_no
			 , clinic_no
			 , surgery_date
			 , surgery_date
			 , textcolor
			 , backgroundcolor
		  from surgery_booking
		 where surgery_status = 'R'

	</select>

	<!-- 수술실 정보 조회 select-->
	<select id="selectOProom" resultMap="OPResult">
		select 
      		   sb.clinic_no
     		 , (select p.patient_name
          		  from patient p
          		  join clinic cll on (cll.chart_no = p.chart_no)) as patient_name
     		 , sb.room_name
     		 , sb.surgery_date
     		 , sb.sur_endtime
     		 , (select m.emp_name
          		 from member m
          		 join clinic clll on (clll.emp_no = m.emp_no)) as doctor_name
		  from surgery_booking sb
		 where booking_no=2000
	</select>
	
	<!-- 수술실 예약을 위한 정보 조회 select-->
	<select id="forinsertOProom" resultMap="SurBookResult">
		select 
      		   sb.clinic_no
     		 , (select p.patient_name
          		  from patient p
          		  join clinic cll on (cll.chart_no = p.chart_no)) as patient_name
     		 , (select m.emp_name
          		 from member m
          		 join clinic clll on (clll.emp_no = m.emp_no)) as doctor_name
		  from surgery_booking sb
		 where booking_no=2000
	</select>
	
	<!-- 수술실 중복 체크 -->
	<select id="checkOverlapRsv" resultType="_int">
		select bcount(*)
		  from
		     ( select booking_no
		         from surgery_booking
		        where sur_endtime &gt; #{surStartTime}
			      and sur_starttime &lt; #{sur_endtime}
		     )
	</select>
	
	<!-- 수술실 예약 insert -->
	<insert id="insertReservation">
		insert
		into surgery_booking
		(
			booking_no
			, clinic_no
			, surgery_no
			, calendar_no
			, room_name
			, surgery_date
			, sur_starttime
			, memo
			, surgery_status
			, doctor_name
			, sur_endtime
			, textcolor
			, backgroundcolor
			)
			values
			(
			seq_sbno.nextval
			, #{clinicNo}
			, #{surNo}
			, seq_rca.nextval
			, #{roomName}
			, #{surDate}
			, #{surTime}
			, #{memo}
			, default
			, #{docName}
			, #{surEnd}
			, 'white'
			, 'navy'
		)
	</insert>
	

	<!-- 수술실 예약 취소 -->
	<update id="rsvCancel">
		update surgery_booking
		   set surgery_status = 'C'
		 where booking_no = #{bookingNo}
	
	</update>
</mapper>
