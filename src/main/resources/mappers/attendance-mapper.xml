<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="attendanceMapper">

	<resultMap id="attendanceResult" type="Attendance">
		<result column="att_no" property="attNo"/>
		<result column="emp_no" property="empNo"/>
		<result column="att_date" property="attDate"/>
		<result column="start_time" property="startTime"/>
		<result column="end_time" property="endTime"/>
		<result column="status" property="status"/>
		<result column="total_time" property="totalTIme"/>
		<result column="over_time" property="overTime"/>
		<result column="modify_date" property="modifyDate"/>
		<result column="modify_no" property="modifyNo"/>
	</resultMap>
	
	<select id="selectListCount" resultType="_int">
		select count(*)
		  from attendance
		 where emp_no = #{empNo}
		 <if test="startDate != null and endDate != null and !startDate.equals('') and !endDate.equals('')">
		   and to_date(att_date) between to_date(#{startDate}) and to_date(#{endDate})
		 </if>
		 <if test='statusArr != null'>
		   and status in 
		   <foreach item="item" index="index" collection="statusArr" open="(" separator="," close=")">
		   	#{item}
		   </foreach>
		 </if>
	</select>

	<select id="selectAttendance" resultMap="attendanceResult">
		select
			   att_no
			 , att_date
			 , NVL(start_time, ' ') as "start_time"
			 , NVL(end_time, ' ') as "end_time"
			 , status
		  from attendance
		 where emp_no = #{empNo}
		 <choose>
		 	<when test='startDate != null and endDate != null and !startDate.equals("") and !endDate.equals("")'>
		 	   and to_date(att_date) between to_date(#{startDate}) and to_date(#{endDate})
		 	</when>
		 	<when test="startDate != null and !startDate.equals('')">
		 	   and to_date(att_date) = to_date(#{startDate})
		 	</when>
		 	<when test="endDate != null and !endDate.equals('')">
		 	   and to_date(att_date) = to_date(#{endDate})
		 	</when>
		 	<otherwise>
		 	</otherwise>
	 	 </choose>
		 <choose>
			 <when test="statusArr != null">
			 	and status in 
			   <foreach item="item" index="index" collection="statusArr" open="(" separator="," close=")">
			   	#{item}
			   </foreach>
			 </when>
		 	 <otherwise>
		 		and status in ('Y', 'L', 'E', 'N')
		 	 </otherwise>
		 </choose>
		 order
		    by att_no desc
	</select>
	
	<insert id="insertAttendance">
		insert 
		  into attendance
		  (
		    att_no
		  , emp_no
		  , att_date
		  , start_time
		  )
		  values
		  (
		    seq_attno.nextval
		  , #{empNo}
		  , to_char(sysdate, 'YYYY-MM-DD')
		  , to_char(sysdate, 'HH:MI')
		  )
	</insert>
	
	<select id="selectStartTime" resultType="String">
		select start_time
		  from attendance
		 where emp_no = #{empNo}
		   and att_date = to_char(sysdate, 'YYYY-MM-DD')
	</select>
	
	<select id="checkStartTime" resultType="String">
		select
		       start_time
		  from attendance
		 where emp_no = 21015860
		   and att_date = to_char(sysdate, 'YYYY-MM-DD')
	</select>
	
	<select id="checkEndTime" resultType="String">
		select
		       end_time
		  from attendance
		 where emp_no = 21015860
		   and att_date = to_char(sysdate, 'YYYY-MM-DD')
	</select>
</mapper>
